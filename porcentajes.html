<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aprende Porcentajes con Gr√°ficas</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&amp;family=Comic+Neue:wght@400;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Fredoka', 'Comic Neue', sans-serif; }
    
    .btn-3d {
      transform: translateY(0);
      box-shadow: 0 6px 0 var(--shadow-color, #1e40af), 0 8px 15px rgba(0,0,0,0.2);
      transition: all 0.1s ease;
    }
    .btn-3d:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 0 var(--shadow-color, #1e40af), 0 12px 20px rgba(0,0,0,0.25);
    }
    .btn-3d:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 var(--shadow-color, #1e40af), 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .animal-btn {
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .animal-btn:hover {
      transform: scale(1.1) rotate(-3deg);
    }
    .animal-btn:active {
      transform: scale(0.95);
    }
    
    .card-float {
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #fbbf24;
      border-radius: 50%;
      animation: sparkle 1.5s ease-in-out infinite;
    }
    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1); }
    }
    
    .chart-bar {
      transition: height 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .pie-segment {
      transition: all 0.5s ease;
    }
    
    .correct-animation {
      animation: correctPulse 0.6s ease;
    }
    @keyframes correctPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .wrong-animation {
      animation: shake 0.5s ease;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    .level-badge {
      position: relative;
      overflow: hidden;
    }
    .level-badge::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shine 3s infinite;
    }
    @keyframes shine {
      0% { transform: translateX(-100%) rotate(45deg); }
      100% { transform: translateX(100%) rotate(45deg); }
    }
    
    .hint-bubble {
      position: relative;
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-radius: 20px;
      padding: 15px 20px;
    }
    .hint-bubble::before {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 30px;
      border-width: 10px 10px 0;
      border-style: solid;
      border-color: #fde68a transparent transparent;
    }
    
    .category-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .category-card:hover {
      transform: translateY(-8px) scale(1.02);
    }
    
    .stars-container .star {
      transition: all 0.3s ease;
    }
    .stars-container .star.earned {
      animation: starEarn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes starEarn {
      0% { transform: scale(0) rotate(-180deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-b from-sky-100 via-sky-50 to-white overflow-auto">
  <div id="app" class="min-h-full w-full">
   <!-- Pantalla de Inicio -->
   <div id="start-screen" class="min-h-full flex flex-col items-center justify-center p-6">
    <div class="relative">
     <div class="sparkle" style="top: -20px; left: -30px; animation-delay: 0s;"></div>
     <div class="sparkle" style="top: 10px; right: -40px; animation-delay: 0.5s;"></div>
     <div class="sparkle" style="bottom: -10px; left: 50%; animation-delay: 1s;"></div>
     <div class="card-float bg-white rounded-3xl shadow-2xl p-8 max-w-md text-center border-4 border-yellow-300">
      <div class="text-6xl mb-4">
       üìäüé®üìà
      </div>
      <h1 id="main-title" class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-4">¬°Aprende Porcentajes!</h1>
      <p class="text-gray-600 mb-6">Crea gr√°ficas divertidas y aprende matem√°ticas jugando</p>
      <div class="space-y-3">
       <button onclick="selectLevel('easy')" class="w-full btn-3d bg-green-400 hover:bg-green-500 text-white font-bold py-4 px-6 rounded-2xl text-lg" style="--shadow-color: #15803d;"> üåü Nivel F√°cil (1¬∞ y 2¬∞ grado) </button> <button onclick="selectLevel('medium')" class="w-full btn-3d bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-4 px-6 rounded-2xl text-lg" style="--shadow-color: #a16207;"> ‚≠ê‚≠ê Nivel Medio (3¬∞ y 4¬∞ grado) </button> <button onclick="selectLevel('hard')" class="w-full btn-3d bg-red-400 hover:bg-red-500 text-white font-bold py-4 px-6 rounded-2xl text-lg" style="--shadow-color: #991b1b;"> ‚≠ê‚≠ê‚≠ê Nivel Dif√≠cil (5¬∞ y 6¬∞ grado) </button>
      </div>
     </div>
    </div>
    <p id="teacher-credit" class="mt-8 text-sm text-gray-500 text-center">‚ù§Ô∏è Material creado con amor por la maestra<br><span class="font-semibold text-purple-600">Mar√≠a Fernanda Flores Valenzuela</span></p>
   </div><!-- Pantalla de Categor√≠as -->
   <div id="category-screen" class="hidden min-h-full p-6">
    <div class="max-w-4xl mx-auto">
     <div class="flex items-center justify-between mb-6">
      <button onclick="goToStart()" class="btn-3d bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-xl" style="--shadow-color: #6b7280;"> ‚Üê Volver </button>
      <div id="level-indicator" class="level-badge px-4 py-2 rounded-full font-bold text-white"></div>
     </div>
     <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">¬°Elige una categor√≠a!</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div onclick="selectCategory('animals')" class="category-card cursor-pointer bg-gradient-to-br from-orange-100 to-orange-200 rounded-3xl p-6 border-4 border-orange-300 shadow-lg">
       <div class="text-5xl text-center mb-4">
        üêï üê± üê¶
       </div>
       <h3 class="text-xl font-bold text-center text-orange-700">Animalitos</h3>
       <p class="text-center text-orange-600 text-sm mt-2">Perritos, gatitos y pajaritos</p>
      </div>
      <div onclick="selectCategory('fruits')" class="category-card cursor-pointer bg-gradient-to-br from-red-100 to-pink-200 rounded-3xl p-6 border-4 border-red-300 shadow-lg">
       <div class="text-5xl text-center mb-4">
        üçé üçä üçá
       </div>
       <h3 class="text-xl font-bold text-center text-red-700">Frutas</h3>
       <p class="text-center text-red-600 text-sm mt-2">Manzanas, naranjas y uvas</p>
      </div>
      <div onclick="selectCategory('vegetables')" class="category-card cursor-pointer bg-gradient-to-br from-green-100 to-emerald-200 rounded-3xl p-6 border-4 border-green-300 shadow-lg">
       <div class="text-5xl text-center mb-4">
        ü•ï ü•¶ üåΩ
       </div>
       <h3 class="text-xl font-bold text-center text-green-700">Verduras</h3>
       <p class="text-center text-green-600 text-sm mt-2">Zanahorias, br√≥coli y elotes</p>
      </div>
      <div onclick="selectCategory('colors')" class="category-card cursor-pointer bg-gradient-to-br from-purple-100 to-blue-200 rounded-3xl p-6 border-4 border-purple-300 shadow-lg">
       <div class="text-5xl text-center mb-4">
        üî¥ üü° üîµ
       </div>
       <h3 class="text-xl font-bold text-center text-purple-700">Colores</h3>
       <p class="text-center text-purple-600 text-sm mt-2">Rojos, amarillos y azules</p>
      </div>
     </div>
    </div>
   </div><!-- Pantalla de Selecci√≥n -->
   <div id="selection-screen" class="hidden min-h-full p-4">
    <div class="max-w-4xl mx-auto">
     <div class="flex items-center justify-between mb-4">
      <button onclick="goToCategories()" class="btn-3d bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-xl text-sm" style="--shadow-color: #6b7280;"> ‚Üê Categor√≠as </button>
      <div id="selection-level" class="level-badge px-3 py-1 rounded-full font-bold text-white text-sm"></div>
     </div>
     <div class="bg-white rounded-3xl shadow-xl p-6 border-4 border-blue-200">
      <h2 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-4">¬°Selecciona tus <span id="category-name"></span>!</h2>
      <p class="text-center text-gray-600 mb-4" id="selection-instruction"></p><!-- Selectores de cantidad -->
      <div id="selectors-container" class="space-y-4 mb-6"></div><!-- Total seleccionado -->
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-4 mb-6">
       <p class="text-center text-lg font-semibold text-gray-700">Total seleccionado: <span id="total-count" class="text-2xl text-blue-600">0</span></p>
      </div><!-- Tipo de gr√°fica -->
      <div class="flex flex-col sm:flex-row gap-3 justify-center mb-6">
       <button onclick="setChartType('bar')" id="btn-bar" class="btn-3d bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-2xl" style="--shadow-color: #1e40af;"> üìä Gr√°fica de Barras </button> <button onclick="setChartType('pie')" id="btn-pie" class="btn-3d bg-purple-400 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-2xl" style="--shadow-color: #6b21a8;"> ü•ß Gr√°fica de Pastel </button>
      </div><button onclick="createChart()" id="create-chart-btn" class="w-full btn-3d bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 text-white font-bold py-4 px-6 rounded-2xl text-xl" style="--shadow-color: #15803d;"> ‚ú® ¬°Crear Gr√°fica! ‚ú® </button>
     </div>
    </div>
   </div><!-- Pantalla de Gr√°fica -->
   <div id="chart-screen" class="hidden min-h-full p-4">
    <div class="max-w-4xl mx-auto">
     <div class="flex items-center justify-between mb-4">
      <button onclick="goToSelection()" class="btn-3d bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-xl text-sm" style="--shadow-color: #6b7280;"> ‚Üê Modificar </button>
      <div class="stars-container flex gap-1" id="stars-display"></div>
     </div>
     <div class="bg-white rounded-3xl shadow-xl p-6 border-4 border-purple-200 mb-4">
      <h2 class="text-xl md:text-2xl font-bold text-center text-purple-700 mb-6">¬°Tu Gr√°fica!</h2><!-- Contenedor de la gr√°fica -->
      <div id="chart-container" class="mb-6"></div><!-- Leyenda -->
      <div id="chart-legend" class="flex flex-wrap justify-center gap-3 mb-6"></div>
     </div><!-- Explicaci√≥n -->
     <div id="explanation-box" class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-3xl shadow-lg p-6 border-4 border-yellow-300 mb-4">
      <h3 class="text-lg font-bold text-orange-700 mb-3 flex items-center gap-2"><span>üí°</span> ¬øC√≥mo calculamos los porcentajes?</h3>
      <div id="explanation-content" class="text-gray-700"></div>
     </div><!-- Secci√≥n de Preguntas -->
     <div id="question-section" class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-3xl shadow-lg p-6 border-4 border-blue-300">
      <h3 class="text-lg font-bold text-blue-700 mb-4 flex items-center gap-2"><span>ü§î</span> ¬°Prueba lo que aprendiste!</h3>
      <div id="question-container"></div><!-- Pistas -->
      <div id="hint-container" class="mt-4 hidden">
       <div class="hint-bubble">
        <p class="text-sm text-yellow-800" id="hint-text"></p>
       </div>
      </div><!-- Resultado -->
      <div id="result-container" class="mt-4 hidden"></div>
     </div><!-- Bot√≥n Nueva Gr√°fica --> <button onclick="newChart()" class="w-full mt-4 btn-3d bg-gradient-to-r from-pink-400 to-rose-500 hover:from-pink-500 hover:to-rose-600 text-white font-bold py-4 px-6 rounded-2xl text-xl" style="--shadow-color: #be123c;"> üé® ¬°Nueva Gr√°fica! </button>
    </div>
   </div>
  </div>
  <script>
    // ==================== CONFIGURACI√ìN ====================
    const defaultConfig = {
      game_title: 'Aprende Porcentajes',
      teacher_name: 'Mar√≠a Fernanda Flores Valenzuela'
    };
    
    let config = { ...defaultConfig };
    
    // ==================== ESTADO DEL JUEGO ====================
    let currentLevel = 'easy';
    let currentCategory = 'animals';
    let chartType = 'bar';
    let selections = {};
    let stars = 0;
    let currentQuestion = null;
    let hintsUsed = 0;
    
    // ==================== DATOS DE CATEGOR√çAS ====================
    const categories = {
      animals: {
        name: 'animalitos',
        items: [
          { id: 'dogs', emoji: 'üêï', name: 'Perritos', color: '#f97316' },
          { id: 'cats', emoji: 'üê±', name: 'Gatitos', color: '#ec4899' },
          { id: 'birds', emoji: 'üê¶', name: 'Pajaritos', color: '#3b82f6' }
        ]
      },
      fruits: {
        name: 'frutas',
        items: [
          { id: 'apples', emoji: 'üçé', name: 'Manzanas', color: '#ef4444' },
          { id: 'oranges', emoji: 'üçä', name: 'Naranjas', color: '#f97316' },
          { id: 'grapes', emoji: 'üçá', name: 'Uvas', color: '#8b5cf6' }
        ]
      },
      vegetables: {
        name: 'verduras',
        items: [
          { id: 'carrots', emoji: 'ü•ï', name: 'Zanahorias', color: '#f97316' },
          { id: 'broccoli', emoji: 'ü•¶', name: 'Br√≥coli', color: '#22c55e' },
          { id: 'corn', emoji: 'üåΩ', name: 'Elotes', color: '#eab308' }
        ]
      },
      colors: {
        name: 'colores',
        items: [
          { id: 'red', emoji: 'üî¥', name: 'Rojos', color: '#ef4444' },
          { id: 'yellow', emoji: 'üü°', name: 'Amarillos', color: '#eab308' },
          { id: 'blue', emoji: 'üîµ', name: 'Azules', color: '#3b82f6' }
        ]
      }
    };
    
    // ==================== CONFIGURACI√ìN POR NIVEL ====================
    const levelConfig = {
      easy: {
        maxPerItem: 5,
        totalRequired: 10,
        badge: 'üåü F√°cil',
        badgeColor: 'bg-green-500',
        showDecimals: false,
        questionType: 'identify', // Solo identificar cu√°l es mayor/menor
        hints: [
          '¬°Cuenta cu√°ntos hay de cada uno!',
          'El que tiene m√°s, tiene mayor porcentaje',
          'Mira las barras: ¬°la m√°s alta es la mayor!'
        ]
      },
      medium: {
        maxPerItem: 10,
        totalRequired: 20,
        badge: '‚≠ê‚≠ê Medio',
        badgeColor: 'bg-yellow-500',
        showDecimals: false,
        questionType: 'calculate', // Calcular porcentaje simple
        hints: [
          'Para sacar el porcentaje: (cantidad √∑ total) √ó 100',
          'Si hay 4 de 20, es 4√∑20 = 0.20, y 0.20 √ó 100 = 20%',
          'Divide la parte entre el total y multiplica por 100'
        ]
      },
      hard: {
        maxPerItem: 15,
        totalRequired: null, // Sin l√≠mite fijo
        badge: '‚≠ê‚≠ê‚≠ê Dif√≠cil',
        badgeColor: 'bg-red-500',
        showDecimals: true,
        questionType: 'advanced', // Porcentajes con decimales
        hints: [
          'F√≥rmula: Porcentaje = (parte √∑ total) √ó 100',
          'Ejemplo: 7 de 23 = (7√∑23)√ó100 = 30.43%',
          'Usa la divisi√≥n y redondea a 2 decimales'
        ]
      }
    };
    
    // ==================== NAVEGACI√ìN ====================
    function showScreen(screenId) {
      document.querySelectorAll('#app > div').forEach(screen => {
        screen.classList.add('hidden');
      });
      document.getElementById(screenId).classList.remove('hidden');
    }
    
    function goToStart() {
      showScreen('start-screen');
      resetGame();
    }
    
    function goToCategories() {
      showScreen('category-screen');
    }
    
    function goToSelection() {
      showScreen('selection-screen');
    }
    
    function selectLevel(level) {
      currentLevel = level;
      const config = levelConfig[level];
      
      document.getElementById('level-indicator').textContent = config.badge;
      document.getElementById('level-indicator').className = `level-badge px-4 py-2 rounded-full font-bold text-white ${config.badgeColor}`;
      
      showScreen('category-screen');
    }
    
    function selectCategory(category) {
      currentCategory = category;
      setupSelectionScreen();
      showScreen('selection-screen');
    }
    
    function resetGame() {
      selections = {};
      stars = 0;
      hintsUsed = 0;
      currentQuestion = null;
    }
    
    // ==================== PANTALLA DE SELECCI√ìN ====================
    function setupSelectionScreen() {
      const cat = categories[currentCategory];
      const levelCfg = levelConfig[currentLevel];
      
      document.getElementById('category-name').textContent = cat.name;
      document.getElementById('selection-level').textContent = levelCfg.badge;
      document.getElementById('selection-level').className = `level-badge px-3 py-1 rounded-full font-bold text-white text-sm ${levelCfg.badgeColor}`;
      
      // Instrucci√≥n seg√∫n nivel
      const instructions = {
        easy: `Elige hasta ${levelCfg.totalRequired} ${cat.name} en total`,
        medium: `Elige hasta ${levelCfg.totalRequired} ${cat.name} en total`,
        hard: `Elige la cantidad que quieras de cada ${cat.name.slice(0, -1)}`
      };
      document.getElementById('selection-instruction').textContent = instructions[currentLevel];
      
      // Crear selectores
      const container = document.getElementById('selectors-container');
      container.innerHTML = '';
      
      cat.items.forEach(item => {
        selections[item.id] = 0;
        
        const selector = document.createElement('div');
        selector.className = 'bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl p-4 flex items-center justify-between';
        selector.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-4xl">${item.emoji}</span>
            <span class="font-bold text-gray-700">${item.name}</span>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="changeCount('${item.id}', -1)" class="animal-btn w-12 h-12 bg-red-400 hover:bg-red-500 text-white font-bold text-2xl rounded-full shadow-lg">‚àí</button>
            <span id="count-${item.id}" class="text-3xl font-bold text-gray-800 w-12 text-center">0</span>
            <button onclick="changeCount('${item.id}', 1)" class="animal-btn w-12 h-12 bg-green-400 hover:bg-green-500 text-white font-bold text-2xl rounded-full shadow-lg">+</button>
          </div>
        `;
        container.appendChild(selector);
      });
      
      updateTotal();
    }
    
    function changeCount(itemId, delta) {
      const levelCfg = levelConfig[currentLevel];
      const currentValue = selections[itemId] || 0;
      let newValue = currentValue + delta;
      
      // Asegurar que no sea negativo
      if (newValue < 0) newValue = 0;
      
      // Limitar al m√°ximo por item
      if (newValue > levelCfg.maxPerItem) newValue = levelCfg.maxPerItem;
      
      // Verificar total si hay l√≠mite
      if (levelCfg.totalRequired) {
        const currentTotal = Object.values(selections).reduce((a, b) => a + b, 0);
        const newTotal = currentTotal - currentValue + newValue;
        if (newTotal > levelCfg.totalRequired) {
          // No permitir si excede el total
          return;
        }
      }
      
      selections[itemId] = newValue;
      document.getElementById(`count-${itemId}`).textContent = newValue;
      updateTotal();
    }
    
    function updateTotal() {
      const total = Object.values(selections).reduce((a, b) => a + b, 0);
      document.getElementById('total-count').textContent = total;
    }
    
    function setChartType(type) {
      chartType = type;
      document.getElementById('btn-bar').className = type === 'bar' 
        ? 'btn-3d bg-blue-600 text-white font-bold py-3 px-6 rounded-2xl ring-4 ring-blue-300'
        : 'btn-3d bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-2xl';
      document.getElementById('btn-pie').className = type === 'pie'
        ? 'btn-3d bg-purple-600 text-white font-bold py-3 px-6 rounded-2xl ring-4 ring-purple-300'
        : 'btn-3d bg-purple-400 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-2xl';
      
      document.getElementById('btn-bar').style.setProperty('--shadow-color', type === 'bar' ? '#1e3a8a' : '#1e40af');
      document.getElementById('btn-pie').style.setProperty('--shadow-color', type === 'pie' ? '#581c87' : '#6b21a8');
    }
    
    // ==================== CREAR GR√ÅFICA ====================
    function createChart() {
      const total = Object.values(selections).reduce((a, b) => a + b, 0);
      if (total === 0) {
        showInlineMessage('¬°Selecciona al menos un elemento!', 'warning');
        return;
      }
      
      renderChart();
      renderExplanation();
      generateQuestion();
      updateStarsDisplay();
      showScreen('chart-screen');
    }
    
    function showInlineMessage(message, type) {
      const btn = document.getElementById('create-chart-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = `‚ö†Ô∏è ${message}`;
      btn.classList.add('bg-yellow-400');
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('bg-yellow-400');
      }, 2000);
    }
    
    function renderChart() {
      const container = document.getElementById('chart-container');
      const legend = document.getElementById('chart-legend');
      const cat = categories[currentCategory];
      const total = Object.values(selections).reduce((a, b) => a + b, 0);
      const levelCfg = levelConfig[currentLevel];
      
      if (chartType === 'bar') {
        container.innerHTML = `
          <div class="flex items-end justify-center gap-4 h-64 px-4">
            ${cat.items.map(item => {
              const count = selections[item.id];
              if (count === 0) return ''; // No mostrar si es 0
              const percentage = total > 0 ? (count / total) * 100 : 0;
              const height = total > 0 ? (count / total) * 100 : 0;
              const displayPercent = levelCfg.showDecimals ? percentage.toFixed(2) : Math.round(percentage);
              return `
                <div class="flex flex-col items-center flex-1 max-w-24">
                  <div class="text-sm font-bold text-gray-700 mb-1">${displayPercent}%</div>
                  <div class="w-full bg-gray-200 rounded-t-xl relative" style="height: 200px;">
                    <div class="chart-bar absolute bottom-0 w-full rounded-t-xl transition-all duration-700" 
                         style="height: ${height}%; background-color: ${item.color};">
                    </div>
                  </div>
                  <div class="mt-2 text-2xl">${item.emoji}</div>
                  <div class="text-xs font-semibold text-gray-600">${count}</div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else {
        // Gr√°fica de pastel con SVG - solo mostrar items con count > 0
        let currentAngle = 0;
        const segments = cat.items.map(item => {
          const count = selections[item.id];
          const percentage = total > 0 ? (count / total) * 100 : 0;
          const angle = (percentage / 100) * 360;
          const segment = { ...item, percentage, startAngle: currentAngle, angle, count };
          currentAngle += angle;
          return segment;
        }).filter(s => s.count > 0); // Solo items con cantidad > 0
        
        const size = 200;
        const center = size / 2;
        const radius = 80;
        
        function polarToCartesian(angle) {
          const rad = (angle - 90) * Math.PI / 180;
          return {
            x: center + radius * Math.cos(rad),
            y: center + radius * Math.sin(rad)
          };
        }
        
        function describeArc(startAngle, endAngle) {
          const start = polarToCartesian(endAngle);
          const end = polarToCartesian(startAngle);
          const largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;
          return `M ${center} ${center} L ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y} Z`;
        }
        
        let svgContent = '';
        segments.forEach((seg, i) => {
          if (seg.angle > 0) {
            const path = describeArc(seg.startAngle, seg.startAngle + seg.angle);
            svgContent += `<path d="${path}" fill="${seg.color}" class="pie-segment" style="animation-delay: ${i * 0.1}s"/>`;
          }
        });
        
        container.innerHTML = `
          <div class="flex justify-center">
            <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
              ${svgContent}
              <circle cx="${center}" cy="${center}" r="30" fill="white"/>
            </svg>
          </div>
        `;
      }
      
      // Leyenda - SOLO mostrar items con cantidad > 0
      const levelCfgForLegend = levelConfig[currentLevel];
      legend.innerHTML = cat.items.map(item => {
        const count = selections[item.id];
        if (count === 0) return ''; // No mostrar en leyenda si es 0
        const percentage = total > 0 ? (count / total) * 100 : 0;
        const displayPercent = levelCfgForLegend.showDecimals ? percentage.toFixed(2) : Math.round(percentage);
        return `
          <div class="flex items-center gap-2 bg-gray-100 px-3 py-2 rounded-xl">
            <div class="w-4 h-4 rounded-full" style="background-color: ${item.color}"></div>
            <span class="text-2xl">${item.emoji}</span>
            <span class="font-semibold">${item.name}: ${count} (${displayPercent}%)</span>
          </div>
        `;
      }).join('');
    }
    
    function renderExplanation() {
      const cat = categories[currentCategory];
      const total = Object.values(selections).reduce((a, b) => a + b, 0);
      const levelCfg = levelConfig[currentLevel];
      
      let explanation = '';
      
      if (currentLevel === 'easy') {
        explanation = `
          <p class="mb-3">¬°Excelente! Tienes <strong>${total} ${cat.name}</strong> en total.</p>
          <ul class="space-y-2">
            ${cat.items.map(item => {
              const count = selections[item.id];
              if (count === 0) return ''; // No mostrar si es 0
              const percentage = Math.round((count / total) * 100);
              return `<li class="flex items-center gap-2">
                <span class="text-xl">${item.emoji}</span>
                <span>${count} ${item.name} = <strong class="text-blue-600">${percentage}%</strong> del total</span>
              </li>`;
            }).join('')}
          </ul>
          <p class="mt-4 p-3 bg-green-100 rounded-xl text-green-800">
            <strong>üí° Tip:</strong> El porcentaje nos dice "de cada 100, ¬øcu√°ntos ser√≠an?"
          </p>
        `;
      } else if (currentLevel === 'medium') {
        explanation = `
          <p class="mb-3">Total: <strong>${total} ${cat.name}</strong></p>
          <div class="bg-blue-50 p-4 rounded-xl mb-4">
            <p class="font-semibold text-blue-800 mb-2">üìê F√≥rmula del porcentaje:</p>
            <p class="text-center text-lg font-mono bg-white p-2 rounded-lg">
              Porcentaje = (cantidad √∑ total) √ó 100
            </p>
          </div>
          <div class="space-y-3">
            ${cat.items.map(item => {
              const count = selections[item.id];
              if (count === 0) return ''; // No mostrar si es 0
              const percentage = Math.round((count / total) * 100);
              return `
                <div class="bg-gray-50 p-3 rounded-xl">
                  <p class="flex items-center gap-2 mb-1">
                    <span class="text-xl">${item.emoji}</span>
                    <strong>${item.name}:</strong>
                  </p>
                  <p class="font-mono text-sm">
                    (${count} √∑ ${total}) √ó 100 = <strong class="text-purple-600">${percentage}%</strong>
                  </p>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else {
        explanation = `
          <p class="mb-3">Total: <strong>${total} ${cat.name}</strong></p>
          <div class="bg-purple-50 p-4 rounded-xl mb-4">
            <p class="font-semibold text-purple-800 mb-2">üìê C√°lculo con decimales:</p>
            <p class="text-center text-lg font-mono bg-white p-2 rounded-lg">
              % = (parte √∑ total) √ó 100
            </p>
          </div>
          <div class="space-y-3">
            ${cat.items.map(item => {
              const count = selections[item.id];
              if (count === 0) return ''; // No mostrar si es 0
              const decimal = count / total;
              const percentage = (count / total) * 100;
              return `
                <div class="bg-gray-50 p-3 rounded-xl">
                  <p class="flex items-center gap-2 mb-1">
                    <span class="text-xl">${item.emoji}</span>
                    <strong>${item.name}:</strong>
                  </p>
                  <p class="font-mono text-sm">
                    ${count} √∑ ${total} = ${decimal.toFixed(4)}<br>
                    ${decimal.toFixed(4)} √ó 100 = <strong class="text-purple-600">${percentage.toFixed(2)}%</strong>
                  </p>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
      
      document.getElementById('explanation-content').innerHTML = explanation;
    }
    
    // ==================== PREGUNTAS ====================
    function generateQuestion() {
      const cat = categories[currentCategory];
      const total = Object.values(selections).reduce((a, b) => a + b, 0);
      const levelCfg = levelConfig[currentLevel];
      const container = document.getElementById('question-container');
      
      hintsUsed = 0;
      document.getElementById('hint-container').classList.add('hidden');
      document.getElementById('result-container').classList.add('hidden');
      
      // Encontrar items con valores > 0
      const activeItems = cat.items.filter(item => selections[item.id] > 0);
      if (activeItems.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No hay datos para preguntas</p>';
        return;
      }
      
      const randomItem = activeItems[Math.floor(Math.random() * activeItems.length)];
      const count = selections[randomItem.id];
      const correctPercentage = levelCfg.showDecimals 
        ? parseFloat(((count / total) * 100).toFixed(2))
        : Math.round((count / total) * 100);
      
      currentQuestion = {
        item: randomItem,
        count,
        total,
        correctAnswer: correctPercentage,
        type: levelCfg.questionType
      };
      
      if (currentLevel === 'easy') {
        // Pregunta de identificaci√≥n
        const sortedItems = [...activeItems].sort((a, b) => selections[b.id] - selections[a.id]);
        const isAskingMost = Math.random() > 0.5;
        const correctItem = isAskingMost ? sortedItems[0] : sortedItems[sortedItems.length - 1];
        
        currentQuestion.correctAnswer = correctItem.id;
        currentQuestion.questionText = isAskingMost 
          ? `¬øCu√°l tiene el MAYOR porcentaje?`
          : `¬øCu√°l tiene el MENOR porcentaje?`;
        
        container.innerHTML = `
          <p class="text-lg font-semibold mb-4">${currentQuestion.questionText}</p>
          <div class="flex flex-wrap gap-3 justify-center">
            ${activeItems.map(item => `
              <button onclick="checkEasyAnswer('${item.id}')" 
                      class="animal-btn btn-3d bg-white border-4 border-gray-200 hover:border-blue-400 p-4 rounded-2xl text-4xl"
                      style="--shadow-color: #9ca3af;">
                ${item.emoji}
              </button>
            `).join('')}
          </div>
        `;
      } else {
        // Pregunta de c√°lculo
        const options = generateOptions(correctPercentage, levelCfg.showDecimals);
        
        container.innerHTML = `
          <p class="text-lg font-semibold mb-2">
            ¬øQu√© porcentaje representan los ${randomItem.emoji} <strong>${randomItem.name}</strong>?
          </p>
          <p class="text-gray-600 mb-4">
            (${count} de ${total} ${cat.name})
          </p>
          <div class="grid grid-cols-2 gap-3">
            ${options.map(opt => `
              <button onclick="checkAnswer(${opt})" 
                      class="btn-3d bg-white border-4 border-gray-200 hover:border-blue-400 py-3 px-4 rounded-2xl font-bold text-xl"
                      style="--shadow-color: #9ca3af;">
                ${opt}%
              </button>
            `).join('')}
          </div>
        `;
      }
      
      // Bot√≥n de pista
      const hintBtn = document.createElement('button');
      hintBtn.onclick = showHint;
      hintBtn.className = 'mt-4 btn-3d bg-yellow-300 hover:bg-yellow-400 text-gray-800 font-bold py-2 px-4 rounded-xl text-sm';
      hintBtn.style.setProperty('--shadow-color', '#a16207');
      hintBtn.innerHTML = 'üí° Necesito una pista';
      container.appendChild(hintBtn);
    }
    
    function generateOptions(correct, showDecimals) {
      const options = new Set([correct]);
      while (options.size < 4) {
        let offset = Math.floor(Math.random() * 30) - 15;
        if (offset === 0) offset = 5;
        let newOption = correct + offset;
        if (newOption < 0) newOption = Math.abs(newOption);
        if (newOption > 100) newOption = 100 - (newOption - 100);
        if (showDecimals) {
          newOption = parseFloat(newOption.toFixed(2));
        } else {
          newOption = Math.round(newOption);
        }
        if (newOption >= 0 && newOption <= 100) {
          options.add(newOption);
        }
      }
      return Array.from(options).sort(() => Math.random() - 0.5);
    }
    
    function checkEasyAnswer(answerId) {
      const correct = answerId === currentQuestion.correctAnswer;
      showResult(correct);
    }
    
    function checkAnswer(answer) {
      const correct = answer === currentQuestion.correctAnswer;
      showResult(correct);
    }
    
    function showResult(correct) {
      const resultContainer = document.getElementById('result-container');
      resultContainer.classList.remove('hidden');
      
      if (correct) {
        stars++;
        updateStarsDisplay();
        resultContainer.innerHTML = `
          <div class="correct-animation bg-green-100 border-4 border-green-400 rounded-2xl p-4 text-center">
            <p class="text-2xl mb-2">üéâ ¬°CORRECTO! üéâ</p>
            <p class="text-green-700">¬°Excelente trabajo! Ganaste una estrella ‚≠ê</p>
          </div>
        `;
      } else {
        resultContainer.innerHTML = `
          <div class="wrong-animation bg-red-100 border-4 border-red-400 rounded-2xl p-4 text-center">
            <p class="text-2xl mb-2">üòÖ ¬°Casi!</p>
            <p class="text-red-700">La respuesta correcta era: <strong>${currentQuestion.correctAnswer}${currentLevel !== 'easy' ? '%' : ''}</strong></p>
            <p class="text-sm text-gray-600 mt-2">¬°No te preocupes, sigue intentando!</p>
          </div>
        `;
      }
      
      // Deshabilitar botones despu√©s de responder
      document.querySelectorAll('#question-container button').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50');
      });
      
      // Bot√≥n para nueva pregunta
      setTimeout(() => {
        const newQuestionBtn = document.createElement('button');
        newQuestionBtn.onclick = generateQuestion;
        newQuestionBtn.className = 'w-full mt-4 btn-3d bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-2xl';
        newQuestionBtn.style.setProperty('--shadow-color', '#1e40af');
        newQuestionBtn.innerHTML = 'üîÑ Otra pregunta';
        resultContainer.appendChild(newQuestionBtn);
      }, 500);
    }
    
    function showHint() {
      const levelCfg = levelConfig[currentLevel];
      const hintContainer = document.getElementById('hint-container');
      const hintText = document.getElementById('hint-text');
      
      if (hintsUsed < levelCfg.hints.length) {
        hintText.textContent = levelCfg.hints[hintsUsed];
        hintsUsed++;
      } else {
        hintText.textContent = '¬°Ya viste todas las pistas! Intenta usar lo que aprendiste.';
      }
      
      hintContainer.classList.remove('hidden');
    }
    
    function updateStarsDisplay() {
      const container = document.getElementById('stars-display');
      container.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const star = document.createElement('span');
        star.className = `star text-2xl ${i < stars ? 'earned' : 'opacity-30'}`;
        star.textContent = '‚≠ê';
        star.style.animationDelay = `${i * 0.1}s`;
        container.appendChild(star);
      }
    }
    
    function newChart() {
      goToCategories();
    }
    
    // ==================== ELEMENT SDK ====================
    async function initApp() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            document.getElementById('main-title').textContent = '¬°' + (config.game_title || defaultConfig.game_title) + '!';
            const teacherName = config.teacher_name || defaultConfig.teacher_name;
            document.getElementById('teacher-credit').innerHTML = `
              ‚ù§Ô∏è Material creado con amor por la maestra<br>
              <span class="font-semibold text-purple-600">${teacherName}</span>
            `;
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['game_title', cfg.game_title || defaultConfig.game_title],
            ['teacher_name', cfg.teacher_name || defaultConfig.teacher_name]
          ])
        });
      }
      
      // Inicializar tipo de gr√°fica
      setChartType('bar');
    }
    
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d56362ee37247a6',t:'MTc3MjM0NzY2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>